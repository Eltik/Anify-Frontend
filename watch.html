<!DOCTYPE html>
    <head>
        <title>Watching Anime</title>
        <link rel="stylesheet" href="../../../styles/global.css">
        <link rel="stylesheet" href="../../../styles/watch.css">
        <link rel="icon" href="../../../images/favicon.ico" />
        <meta charset="utf-8">

        <meta name="title" content="Watching Anime" />
        <meta name="description" content="Loading information..." />

        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://anify.tv/anime" />
        <meta property="og:title" content="Watching Anime" />
        <meta property="og:description" content="Loading information..." />
        <meta property="og:image" content="" />

        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content="https://anify.tv/anime" />
        <meta property="twitter:title" content="Watching Anime"/>
        <meta property="twitter:description" content="Loading information..." />
        <meta property="twitter:image" content="" />

        <script src="https://cdn.jsdelivr.net/npm/js-base64@3.7.3/base64.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest/dist/hls.min.js"></script>
        <script src="../../../scripts/libraries/anime.min.js"></script>
        <script src="../../../scripts/libraries/cryptojs.min.js"></script>
        <script src="../../../scripts/global.min.js"></script>
        <script src="../../../scripts/watch.min.js"></script>
        <style>
            video {
                width: 100%;
                height: 100%;
            }
        </style>
        <script>
            init().then(async() => {
                const id = window.location.pathname.split("/")[2];
                const provider = window.location.pathname.split("/")[3];
                const watchId = window.location.pathname.split("/")[4];
                load(id, provider, watchId, true);

                let sources = [];
                let subtitles = [];
                let intro = [];

                let info = null;
                let episodes = [];

                let isRaw = false;

                function rawVideo() {
                    const button = document.querySelector(".alternative button");
                    if (sources.length === 0) {
                        return;
                    }
                    if (!isRaw) {
                        const player = document.querySelector(".player");
                        player.innerHTML = "";
                        const video = document.createElement("video");
                        video.controls = true;
                        video.autoplay = true;

                        for (let i = 0; i < subtitles.length; i++) {
                            const subtitleSrc = "/subtitles?url=" + subtitles[i].url;
                            const subtitleLabel = subtitles[i].lang;
                            subs.push({
                                src: subtitleSrc,
                                name: subtitleLabel
                            })
                            let newEl = document.createElement("track");
                            newEl.src = subtitleSrc;
                            newEl.label = subtitleLabel;
                            newEl.className = "subtitle";
                            video.append(newEl);
                        }

                        if (Hls.isSupported()) {
                            hls = new Hls();
                            hls.loadSource(sources[sources.length - 1].url);
                            hls.attachMedia(video);

                            hls.on(Hls.Events.MANIFEST_PARSED,function() {
                                let promise = document.querySelector('video').play();
                                if (promise !== undefined) {
                                    promise.then(_ => {
                                        // Playing
                                    }).catch(error => {
                                        // Can't play
                                    });
                                }
                            });
                        } else {
                            video.src = source;
                        }

                        player.appendChild(video);
                        isRaw = true;
                        button.textContent = "Try Custom Player";
                    } else {
                        loadPlayer();
                        isRaw = false;
                        button.textContent = "Try Raw Video";
                    }
                }
            });
        </script>
    </head>

    <body>
        <div class="alternative">
            <button type="button" class="button" onclick="rawVideo()">Try Raw Video</button>
        </div>
        <div class="player">
        </div>
    </body>
</html>